<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JOHNNY ‚Äî Voice Chat</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Inter:wght@400;500;600&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --purple: #a855f7;
    --purple-bright: #c084fc;
    --teal: #06d6a0;
    --bg: #0a0a0f;
    --bg2: #111118;
    --card: #16161e;
    --border: #2a2a3a;
  }

  body {
    background: var(--bg);
    color: #e0e0e0;
    font-family: 'Inter', sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* ---- Header ---- */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
  }
  .header h1 {
    font-family: 'Orbitron', monospace;
    font-size: 16px;
    color: var(--purple-bright);
    letter-spacing: 2px;
  }
  .voice-select {
    background: var(--card);
    color: var(--teal);
    border: 1px solid var(--border);
    padding: 6px 12px;
    border-radius: 6px;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    cursor: pointer;
  }
  .voice-select:focus { outline: 1px solid var(--purple); }

  /* ---- Main Area ---- */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow-y: auto;
    padding: 20px;
  }

  /* ---- Avatar ---- */
  .avatar-container {
    position: relative;
    width: 280px;
    height: 280px;
    margin-bottom: 20px;
  }
  .avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--purple);
    box-shadow: 0 0 30px rgba(168, 85, 247, 0.3);
    transition: box-shadow 0.3s;
  }
  .avatar-img.speaking {
    border-color: var(--teal);
    box-shadow: 0 0 50px rgba(6, 214, 160, 0.5), 0 0 100px rgba(6, 214, 160, 0.2);
  }
  .avatar-ring {
    position: absolute;
    inset: -8px;
    border-radius: 50%;
    border: 2px solid transparent;
    border-top-color: var(--purple);
    animation: spin 4s linear infinite;
  }
  .avatar-ring.speaking { border-top-color: var(--teal); animation-duration: 1s; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Audio visualizer ring */
  .viz-canvas {
    position: absolute;
    inset: -20px;
    width: calc(100% + 40px);
    height: calc(100% + 40px);
    pointer-events: none;
  }

  /* ---- Status ---- */
  .status {
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    color: #666;
    margin-bottom: 16px;
    min-height: 18px;
    text-align: center;
  }
  .status.active { color: var(--teal); }
  .status.error { color: #f87171; }

  /* ---- Chat History ---- */
  .chat-history {
    width: 100%;
    max-width: 500px;
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 16px;
    padding: 0 4px;
  }
  .chat-msg {
    padding: 8px 12px;
    margin-bottom: 8px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.4;
    max-width: 85%;
    word-wrap: break-word;
  }
  .chat-msg.user {
    background: var(--purple);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
  }
  .chat-msg.ai {
    background: var(--card);
    border: 1px solid var(--border);
    color: #d0d0d0;
    margin-right: auto;
    border-bottom-left-radius: 4px;
  }

  /* ---- Input ---- */
  .input-area {
    width: 100%;
    max-width: 500px;
    display: flex;
    gap: 8px;
    padding: 0 4px;
  }
  .chat-input {
    flex: 1;
    background: var(--card);
    border: 1px solid var(--border);
    color: #e0e0e0;
    padding: 12px 16px;
    border-radius: 24px;
    font-size: 15px;
    font-family: 'Inter', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }
  .chat-input:focus { border-color: var(--purple); }
  .chat-input::placeholder { color: #555; }

  .btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: transform 0.1s, opacity 0.2s;
  }
  .btn:active { transform: scale(0.9); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-send {
    background: var(--purple);
    color: white;
  }
  .btn-mic {
    background: var(--card);
    border: 1px solid var(--border);
    color: #999;
  }
  .btn-mic.active {
    background: #dc2626;
    border-color: #dc2626;
    color: white;
    animation: pulse-mic 1.5s ease-in-out infinite;
  }
  @keyframes pulse-mic {
    0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
    50% { box-shadow: 0 0 0 12px rgba(220, 38, 38, 0); }
  }

  /* ---- Particles ---- */
  .particles {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: -1;
    overflow: hidden;
  }
  .particle {
    position: absolute;
    width: 2px;
    height: 2px;
    background: var(--purple);
    border-radius: 50%;
    opacity: 0.3;
    animation: float-up linear infinite;
  }
  @keyframes float-up {
    0% { transform: translateY(100vh) scale(1); opacity: 0; }
    10% { opacity: 0.3; }
    90% { opacity: 0.3; }
    100% { transform: translateY(-20px) scale(0); opacity: 0; }
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
</style>
</head>
<body>

<div class="particles" id="particles"></div>

<div class="header">
  <h1>‚ö° JOHNNY</h1>
  <select class="voice-select" id="voiceSelect">
    <option value="scott-adams">üìê Scott Adams</option>
    <option value="mike-rowe">üîß Mike Rowe</option>
    <option value="johnny5">ü§ñ Johnny 5</option>
    <option value="mark-dancer">üé≠ Mark Dancer</option>
    <option value="jack-marlowe">üé¨ Jack Marlowe</option>
    <option value="burt">üìñ Burt</option>
    <option value="angelo">üí™ Angelo</option>
  </select>
</div>

<div class="main">
  <div class="avatar-container" id="avatarContainer">
    <div class="avatar-ring" id="avatarRing"></div>
    <canvas class="viz-canvas" id="vizCanvas"></canvas>
    <img class="avatar-img" id="avatarImg" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='280' height='280'%3E%3Crect fill='%2316161e' width='280' height='280' rx='140'/%3E%3Ctext x='140' y='150' text-anchor='middle' fill='%23a855f7' font-size='48'%3E‚ö°%3C/text%3E%3C/svg%3E" alt="Johnny">
  </div>

  <div class="status" id="status">Ready to chat ‚Äî pick a voice and say something</div>

  <div class="chat-history" id="chatHistory"></div>

  <div class="input-area">
    <button class="btn btn-mic" id="micBtn" title="Hold to speak">üé§</button>
    <input class="chat-input" id="chatInput" placeholder="Type a message..." autocomplete="off">
    <button class="btn btn-send" id="sendBtn" title="Send">‚û§</button>
  </div>
</div>

<script>
// Use relay server for API ‚Äî GitHub Pages can't run backend
const API_BASE = window.location.hostname === 'localhost' ? window.location.origin : 'https://thelightparkapp.com';
const chatHistory = document.getElementById('chatHistory');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');
const voiceSelect = document.getElementById('voiceSelect');
const statusEl = document.getElementById('status');
const avatarImg = document.getElementById('avatarImg');
const avatarRing = document.getElementById('avatarRing');
const vizCanvas = document.getElementById('vizCanvas');
const vizCtx = vizCanvas.getContext('2d');

let conversationHistory = [];
let isSpeaking = false;
let audioCtx = null;
let analyser = null;
let currentAudio = null;

// ---- Avatar images per voice ----
const avatarImages = {
  'mike-rowe': 'avatar-mikerowe.png',
  'scott-adams': 'avatar-scottadams.png',
  'johnny5': 'avatar-robot.png',
  'default': 'avatar-mikerowe.png'
};

// Load avatar on voice change
voiceSelect.addEventListener('change', () => {
  const voice = voiceSelect.value;
  const imgFile = avatarImages[voice] || avatarImages['default'];
  avatarImg.src = imgFile;
  avatarImg.onerror = () => {
    // Fallback to placeholder
    avatarImg.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='280' height='280'%3E%3Crect fill='%2316161e' width='280' height='280' rx='140'/%3E%3Ctext x='140' y='150' text-anchor='middle' fill='%23a855f7' font-size='48'%3E‚ö°%3C/text%3E%3C/svg%3E`;
  };
});

// Load initial avatar
voiceSelect.dispatchEvent(new Event('change'));

// ---- Particles ----
const particlesEl = document.getElementById('particles');
for (let i = 0; i < 30; i++) {
  const p = document.createElement('div');
  p.className = 'particle';
  p.style.left = Math.random() * 100 + '%';
  p.style.animationDuration = (8 + Math.random() * 12) + 's';
  p.style.animationDelay = Math.random() * 10 + 's';
  p.style.background = Math.random() > 0.5 ? '#a855f7' : '#06d6a0';
  particlesEl.appendChild(p);
}

// ---- Audio Visualizer ----
function drawVisualizer() {
  const w = vizCanvas.width = vizCanvas.offsetWidth * 2;
  const h = vizCanvas.height = vizCanvas.offsetHeight * 2;
  vizCtx.clearRect(0, 0, w, h);

  if (!analyser || !isSpeaking) {
    requestAnimationFrame(drawVisualizer);
    return;
  }

  const data = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);

  const cx = w / 2, cy = h / 2, radius = w / 2 - 20;
  const bars = 64;
  
  vizCtx.lineWidth = 2;
  
  for (let i = 0; i < bars; i++) {
    const angle = (i / bars) * Math.PI * 2 - Math.PI / 2;
    const idx = Math.floor((i / bars) * data.length);
    const val = data[idx] / 255;
    const barLen = val * 40 + 2;
    
    const x1 = cx + Math.cos(angle) * radius;
    const y1 = cy + Math.sin(angle) * radius;
    const x2 = cx + Math.cos(angle) * (radius + barLen);
    const y2 = cy + Math.sin(angle) * (radius + barLen);
    
    vizCtx.strokeStyle = `rgba(6, 214, 160, ${0.3 + val * 0.7})`;
    vizCtx.beginPath();
    vizCtx.moveTo(x1, y1);
    vizCtx.lineTo(x2, y2);
    vizCtx.stroke();
  }

  requestAnimationFrame(drawVisualizer);
}
drawVisualizer();

// ---- Chat Functions ----
function addMessage(text, role) {
  const div = document.createElement('div');
  div.className = `chat-msg ${role}`;
  div.textContent = text;
  chatHistory.appendChild(div);
  chatHistory.scrollTop = chatHistory.scrollHeight;
}

function setStatus(text, type = '') {
  statusEl.textContent = text;
  statusEl.className = 'status ' + type;
}

function setSpeaking(val) {
  isSpeaking = val;
  avatarImg.classList.toggle('speaking', val);
  avatarRing.classList.toggle('speaking', val);
}

async function speak(text) {
  const voice = voiceSelect.value;
  setStatus('Speaking...', 'active');
  setSpeaking(true);

  try {
    const resp = await fetch(`${API_BASE}/api/tts`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text, voice })
    });

    if (!resp.ok) throw new Error('TTS failed');

    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);

    if (currentAudio) { currentAudio.pause(); currentAudio = null; }

    const audio = new Audio(url);
    currentAudio = audio;

    // Set up audio context for visualizer
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaElementSource(audio);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    source.connect(analyser);
    analyser.connect(audioCtx.destination);

    audio.onended = () => {
      setSpeaking(false);
      setStatus('Ready', '');
      URL.revokeObjectURL(url);
      currentAudio = null;
    };

    await audio.play();
  } catch (e) {
    console.error('TTS error:', e);
    setSpeaking(false);
    setStatus('Voice error ‚Äî try again', 'error');
  }
}

async function sendMessage() {
  const text = chatInput.value.trim();
  if (!text) return;

  chatInput.value = '';
  sendBtn.disabled = true;
  addMessage(text, 'user');
  conversationHistory.push({ role: 'user', content: text });

  setStatus('Thinking...', 'active');

  try {
    const voice = voiceSelect.value;
    const resp = await fetch(`${API_BASE}/api/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text, voice, history: conversationHistory.slice(-6) })
    });

    const data = await resp.json();
    const reply = data.reply || 'Hmm, got nothing.';

    addMessage(reply, 'ai');
    conversationHistory.push({ role: 'assistant', content: reply });

    // Speak the reply
    await speak(reply);
  } catch (e) {
    console.error('Chat error:', e);
    setStatus('Connection error', 'error');
    addMessage('‚ö†Ô∏è Connection failed ‚Äî try again', 'ai');
  } finally {
    sendBtn.disabled = false;
    chatInput.focus();
  }
}

// ---- Event Listeners ----
sendBtn.addEventListener('click', sendMessage);
chatInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// ---- Speech Recognition ----
let recognition = null;
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  let isListening = false;

  recognition.onresult = (e) => {
    const transcript = Array.from(e.results)
      .map(r => r[0].transcript)
      .join('');
    chatInput.value = transcript;
    
    if (e.results[e.results.length - 1].isFinal) {
      recognition.stop();
    }
  };

  recognition.onend = () => {
    isListening = false;
    micBtn.classList.remove('active');
    setStatus('Ready', '');
    // Auto-send if there's text
    if (chatInput.value.trim()) {
      sendMessage();
    }
  };

  recognition.onerror = (e) => {
    isListening = false;
    micBtn.classList.remove('active');
    if (e.error !== 'no-speech') {
      setStatus('Mic error: ' + e.error, 'error');
    }
  };

  micBtn.addEventListener('click', () => {
    if (isListening) {
      recognition.stop();
    } else {
      // Stop any playing audio
      if (currentAudio) { currentAudio.pause(); currentAudio = null; setSpeaking(false); }
      isListening = true;
      micBtn.classList.add('active');
      setStatus('Listening...', 'active');
      recognition.start();
    }
  });
} else {
  micBtn.style.display = 'none';
}

// Focus input on load
chatInput.focus();
</script>
</body>
</html>
